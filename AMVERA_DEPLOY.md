# Развертывание Monastyr на Amvera Cloud

## Обзор

Amvera Cloud - это российская облачная платформа для развертывания приложений. Проект Monastyr настроен для развертывания на Amvera с использованием Docker контейнеров.

## Предварительные требования

1. Аккаунт на https://cloud.amvera.ru/
2. Установленный Git
3. Настроенная база данных MySQL (можно использовать облачную базу данных)

## Структура развертывания

Проект состоит из двух отдельных сервисов:
- **Backend** (API сервер) - Node.js/Express + Prisma + MySQL
- **Frontend** (веб-приложение) - React + Vite

## Шаг 1: Подготовка репозитория

1. Убедитесь, что все файлы закоммичены в Git
2. Отправьте код в GitHub или другой Git-репозиторий

## Шаг 2: Настройка базы данных

### Вариант A: Использование внешней базы данных MySQL

1. Создайте базу данных MySQL (можно использовать облачные сервисы)
2. Запишите строку подключения в формате:
   ```
   mysql://username:password@hostname:3306/database_name
   ```

### Вариант B: Использование Amvera Database (если доступно)

1. В панели Amvera создайте новую базу данных MySQL
2. Получите строку подключения

## Шаг 3: Развертывание Backend

1. Войдите в панель управления Amvera Cloud
2. Создайте новый проект (Backend API)
3. Подключите ваш Git-репозиторий
4. Установите путь к проекту: `/backend`
5. Amvera автоматически обнаружит файл `amvera.yaml`

### Настройка переменных окружения Backend:

В панели управления проектом добавьте следующие переменные:

```
DATABASE_URL=mysql://username:password@hostname:3306/database_name
NODE_ENV=production
PORT=80
FRONTEND_URL=https://your-frontend-app.amvera.io
SESSION_SECRET=your-very-secure-random-string-here
```

6. Запустите развертывание
7. После успешного развертывания запишите URL backend сервиса

## Шаг 4: Развертывание Frontend

1. Создайте второй проект в Amvera (Frontend)
2. Подключите тот же Git-репозиторий
3. Установите путь к проекту: `/webapp`
4. Amvera автоматически обнаружит файл `amvera.yaml`

### Настройка переменных окружения Frontend:

```
VITE_API_URL=https://your-backend-app.amvera.io
NODE_ENV=production
```

5. Запустите развертывание
6. После успешного развертывания ваше приложение будет доступно

## Шаг 5: Настройка CORS

Обновите переменную `FRONTEND_URL` в backend проекте на фактический URL frontend приложения.

## Структура файлов для Amvera

```
monastyr/
├── backend/
│   ├── Dockerfile.amvera      # Оптимизированный Dockerfile для Amvera
│   ├── amvera.yaml           # Конфигурация Amvera для backend
│   └── ... (остальные файлы backend)
├── webapp/
│   ├── Dockerfile.amvera      # Оптимизированный Dockerfile для frontend
│   ├── amvera.yaml           # Конфигурация Amvera для frontend
│   └── ... (остальные файлы frontend)
├── .env.amvera.backend       # Шаблон переменных окружения для backend
└── .env.amvera.frontend      # Шаблон переменных окружения для frontend
```

## Мониторинг и отладка

1. **Логи**: Используйте панель Amvera для просмотра логов развертывания и выполнения
2. **Health Check**: Backend включает endpoint `/health` для проверки состояния
3. **Ошибки CORS**: Убедитесь, что FRONTEND_URL в backend соответствует фактическому URL frontend

## Обновление приложения

1. Внесите изменения в код
2. Закоммитьте и отправьте изменения в Git-репозиторий
3. В панели Amvera нажмите кнопку пересборки для соответствующего сервиса

## Использование базы данных

После первого развертывания backend:

1. Выполните миграции Prisma (если требуется)
2. Заполните базу начальными данными (если необходимо)

Для выполнения команд Prisma можно использовать терминал в панели Amvera или подключиться через SSH (если доступно).

## Безопасность

1. Используйте надежные пароли для базы данных
2. Установите сложный SESSION_SECRET
3. Регулярно обновляйте зависимости
4. Мониторьте логи на предмет подозрительной активности

## Поддержка

При возникновении проблем:
1. Проверьте логи в панели Amvera
2. Убедитесь в правильности переменных окружения
3. Проверьте доступность базы данных
4. Обратитесь к документации Amvera Cloud

## Полезные ссылки

- [Документация Amvera Cloud](https://cloud.amvera.ru/docs)
- [Документация Prisma](https://www.prisma.io/docs)
- [Документация Docker](https://docs.docker.com/)
